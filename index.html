<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HYPER STORE ‚Äî Single File</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0e0017;--fg:#fff;--glow:#ff00ff;--glow2:#7a00ff;
      --ok1:#059669;--ok2:#10b981;--warn1:#b45309;--warn2:#f59e0b;--info1:#3b82f6;--muted:#ffffff33;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Orbitron',sans-serif;background:var(--bg);color:var(--fg)}
    a{color:#ffd6ff}
    .topbar{position:sticky;top:0;z-index:20;display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(0,0,0,.6);backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid #ffffff22}
    .brand{letter-spacing:1px}
    .btn{cursor:pointer; padding:10px 16px;border-radius:18px;border:1px solid transparent;background:linear-gradient(90deg,var(--glow2),var(--glow));color:#fff}
    .btn.ghost{background:transparent;border-color:var(--glow)}
    .btn.ok{background:linear-gradient(90deg,var(--ok1),var(--ok2))}
    .btn.warn{background:linear-gradient(90deg,var(--warn1),var(--warn2))}
    .btn.info{background:linear-gradient(90deg,var(--info1),#60a5fa)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .card{background:rgba(0,0,0,.55);padding:16px;border-radius:16px;border:1px solid rgba(255,0,255,.3);box-shadow:0 0 14px rgba(255,0,255,.18)}
    .category-title{font-size:18px;margin:18px 0 8px;color:#ffd6ff;text-shadow:0 0 8px var(--glow)}
    .price{opacity:.9;margin-top:6px}
    .muted{color:#ffffffaa}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input, textarea, select{width:100%;padding:10px;border-radius:12px;border:1px solid #ffffff33;background:rgba(0,0,0,.4);color:#fff}
    .status{display:inline-block;padding:6px 10px;border-radius:10px;border:1px solid #ffffff33}
    .status.pending{background:#f59e0b33;border-color:#f59e0b66}
    .status.confirmed{background:#60a5fa33;border-color:#60a5fa66}
    .status.delivered{background:#10b98133;border-color:#10b98166}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #ffffff22;text-align:left}
    .pill{padding:4px 10px;border:1px solid #ffffff22;border-radius:999px}
    .stars{font-size:18px;letter-spacing:2px}
    .hidden{display:none}
    footer{opacity:.8;padding:40px 0}
    /* Mobile tweaks */
    @media (max-width:768px){.wrap{padding:12px}.grid{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}.topbar{flex-wrap:wrap;gap:6px}}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">HYPER <span style="color:#ffd6ff">STORE</span></div>
    <nav class="row">
      <button class="btn ghost" data-link="#/catalog">–ö–∞—Ç–∞–ª–æ–≥</button>
      <button class="btn ghost" data-link="#/cart">–ö–æ—Ä–∑–∏–Ω–∞</button>
      <button class="btn ghost" data-link="#/orders">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</button>
      <button class="btn ghost" data-link="#/profile">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button>
      <button class="btn ghost" data-link="#/admin">–ê–¥–º–∏–Ω</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- CATALOG -->
    <section id="page-catalog" class="page">
      <h2>–ö–∞—Ç–∞–ª–æ–≥</h2>
      <div class="row" style="margin:6px 0 14px">
        <input id="search" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É..."/>
      </div>
      <div class="category-title">Android</div>
      <div id="androidGrid" class="grid"></div>
      <div class="category-title">iOS</div>
      <div id="iosGrid" class="grid"></div>
    </section>

    <!-- PRODUCT (modal-like inline) -->
    <section id="page-product" class="page hidden">
      <button class="btn ghost" data-link="#/catalog">‚Üê –ù–∞–∑–∞–¥</button>
      <div id="productView" class="card"></div>
      <div class="card" style="margin-top:12px">
        <h3>–û—Ç–∑—ã–≤—ã</h3>
        <div id="reviewsList"></div>
        <div style="margin-top:12px">
          <textarea id="revText" class="input" placeholder="–í–∞—à –æ—Ç–∑—ã–≤..."></textarea>
          <div class="row" style="margin-top:8px">
            <label>–û—Ü–µ–Ω–∫–∞:
              <select id="revRate" class="input" style="max-width:140px">
                <option value="5">5</option><option value="4">4</option><option value="3">3</option>
                <option value="2">2</option><option value="1">1</option>
              </select>
            </label>
            <button class="btn" id="btnAddReview">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CHECKOUT (after selecting from cart or buy) -->
    <section id="page-checkout" class="page hidden">
      <button class="btn ghost" data-link="#/catalog">‚Üê –ù–∞–∑–∞–¥</button>
      <div class="card">
        <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
        <div id="checkoutSummary" class="muted"></div>
        <h3>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
        <label><input type="radio" name="paymethod" value="–ö–∞—Ä—Ç–∞" checked> üí≥ –ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –î–∞–Ω–∏–ª –ê–ª–µ–∫—Å–µ–µ–≤–∏—á (2202208307028754 —Å–±–µ—Ä)</label><br>
        <label><input type="radio" name="paymethod" value="–Æ–º–∞–Ω–∏"> üì± –Æ–º–∞–Ω–∏ —Ç–µ–Ω–≥–µ –µ–≤—Ä–æ  (5599002099492383)</label><br>
        <label><input type="radio" name="paymethod" value="USDT"> ‚Çø USDT (–ø–æ–∫–∞ –Ω–µ—Ç)</label>
        <textarea id="customerNote" class="input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ–ø–ª–∞—Ç–µ (–≤—Ä–µ–º—è, —Å—É–º–º–∞, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã)..."></textarea>
        <div class="row"><button class="btn" id="btnPayDone">–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)</button></div>
      </div>
    </section>

    <!-- WAITING / STATUS -->
    <section id="page-wait" class="page hidden">
      <div class="card">
        <h2>–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h2>
        <div id="waitInfo"></div>
        <div id="waitStatus" class="status pending">pending</div>
      </div>
    </section>

    <!-- DELIVERED -->
    <section id="page-delivery" class="page hidden">
      <div class="card">
        <h2>–î–æ—Å—Ç—É–ø –≤—ã–¥–∞–Ω</h2>
        <div id="deliverKey"></div>
        <div id="deliverFiles" class="row" style="margin-top:10px;flex-wrap:wrap"></div>
        <button class="btn info" data-link="#/orders">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–∫–∞–∑–∞–º</button>
      </div>
    </section>

    <!-- CART -->
    <section id="page-cart" class="page hidden">
      <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
      <div id="cartList"></div>
      <div class="row" style="margin-top:10px"><button class="btn" id="btnGoCheckout">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é</button></div>
    </section>

    <!-- ORDERS -->
    <section id="page-orders" class="page hidden">
      <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
      <div class="card">
        <table>
          <thead><tr><th>ID</th><th>–¢–æ–≤–∞—Ä</th><th>–¶–µ–Ω–∞</th><th>–û–ø–ª–∞—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="page-profile" class="page hidden">
      <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
      <div class="card">
        <div id="profileBox"></div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="page-admin" class="page hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
          <div id="adminAuth"></div>
        </div>
      </div>
      <div id="adminArea" class="hidden">
        <div class="card">
          <h3>–ó–∞–∫–∞–∑—ã</h3>
          <table>
            <thead><tr><th>ID</th><th>–¢–æ–≤–∞—Ä</th><th>–¶–µ–Ω–∞</th><th>–û–ø–ª–∞—Ç–∞</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="adminOrders"></tbody>
          </table>
        </div>
        <div class="card">
          <h3>–í—ã–¥–∞—Ç—å —Ñ–∞–π–ª—ã (–¥–æ 20 —à—Ç –Ω–∞ –∑–∞–∫–∞–∑)</h3>
          <div class="row">
            <input id="fileOrderId" class="input" placeholder="ID –∑–∞–∫–∞–∑–∞" style="max-width:220px">
            <input id="fileInput" type="file" multiple class="input"/>
            <button class="btn ok" id="btnAttachFiles">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫ –∑–∞–∫–∞–∑—É</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="wrap">
    <div class="muted">¬© HYPER STORE. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</div>
  </footer>

<script>
/*************************
 * Minimal SPA Router
 *************************/
const pages = {
  '#/catalog':'page-catalog', '#/cart':'page-cart', '#/checkout':'page-checkout',
  '#/wait':'page-wait', '#/delivered':'page-delivery', '#/orders':'page-orders',
  '#/profile':'page-profile', '#/admin':'page-admin', '#/product':'page-product'
};
function show(hash){
  // default
  if(!hash || !(hash in pages)) hash = '#/catalog';
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  document.getElementById(pages[hash]).classList.remove('hidden');
  // per-page hooks
  if(hash==="#/catalog") renderCatalog();
  if(hash==="#/cart") renderCart();
  if(hash==="#/orders") renderOrdersTable();
  if(hash==="#/profile") renderProfile();
  if(hash==="#/admin") renderAdmin();
}
window.addEventListener('hashchange',()=>{
  const h = location.hash.split('?')[0];
  // product deep-link: #/product:id
  if(h.startsWith('#/product')){
    const pid = h.split(':')[1];
    openProduct(pid);
  } else {
    show(h);
  }
});
document.querySelectorAll('[data-link]').forEach(b=>b.addEventListener('click', e=>{location.hash=e.currentTarget.dataset.link;}));

/*************************
 * Demo data & helpers
 *************************/
const PRODUCTS=[
  {id:'and1', os:'android', name:'–ü–æ–¥–ø–∏—Å–∫–∞ 1 –¥–µ–Ω—å', price:200, desc:'–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç. –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–∞ 24 —á–∞—Å–∞.'},
  {id:'and7', os:'android', name:'–ü–æ–¥–ø–∏—Å–∫–∞ 7 –¥–Ω–µ–π', price:300, desc:'–ù–µ–¥–µ–ª—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ —Å–Ω–∏–∂–µ–Ω–Ω–æ–π —Ü–µ–Ω–µ.'},
  {id:'and30', os:'android', name:'–ü–æ–¥–ø–∏—Å–∫–∞ 30 –¥–Ω–µ–π', price:400, desc:'–û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.'},
  {id:'and365', os:'android', name:'–ü–æ–¥–ø–∏—Å–∫–∞ 365 –¥–Ω–µ–π', price:700, desc:'–õ—É—á—à–µ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω–∞/—Å—Ä–æ–∫.'},
  {id:'andForever', os:'android', name:'–ü–æ–¥–ø–∏—Å–∫–∞ –≤—Å–µ–≥–¥–∞', price:800, desc:'–ï–¥–∏–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –∏ –¥–æ—Å—Ç—É–ø –Ω–∞–≤—Å–µ–≥–¥–∞.'},
  {id:'ios1', os:'ios', name:'–ü–æ–¥–ø–∏—Å–∫–∞ 1 –¥–µ–Ω—å', price:200, desc:'24 —á–∞—Å–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è iOS.'},
  {id:'ios7', os:'ios', name:'–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–¥–µ–ª—è', price:300, desc:'7 –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞.'},
  {id:'ios30', os:'ios', name:'–ü–æ–¥–ø–∏—Å–∫–∞ –º–µ—Å—è—Ü', price:600, desc:'30 –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è iOS.'},
  {id:'ios365', os:'ios', name:'–ü–æ–¥–ø–∏—Å–∫–∞ –≥–æ–¥', price:1000, desc:'12 –º–µ—Å—è—Ü–µ–≤ –¥–æ—Å—Ç—É–ø–∞.'}
];
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/*************************
 * IndexedDB tiny layer
 *************************/
const DB={db:null};
function dbOpen(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open('hyperDB',3);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('orders')) db.createObjectStore('orders',{keyPath:'id'});
      if(!db.objectStoreNames.contains('files')) db.createObjectStore('files',{keyPath:'fid'});
      if(!db.objectStoreNames.contains('reviews')) db.createObjectStore('reviews',{keyPath:'rid'});
      if(!db.objectStoreNames.contains('meta')) db.createObjectStore('meta',{keyPath:'key'});
    };
    req.onsuccess=()=>{DB.db=req.result;res()};
    req.onerror=()=>rej(req.error);
  });
}
function tx(store,mode='readonly'){return DB.db.transaction(store,mode).objectStore(store)}
// ORDERS
async function ordersGetAll(){return new Promise((res)=>{const r=tx('orders').getAll();r.onsuccess=()=>res(r.result||[])})}
async function ordersPut(o){return new Promise((res)=>{const r=tx('orders','readwrite').put(o);r.onsuccess=()=>res(true)})}
async function ordersGet(id){return new Promise((res)=>{const r=tx('orders').get(id);r.onsuccess=()=>res(r.result)})}
// FILES
async function filePut(fid, obj){return new Promise((res)=>{const r=tx('files','readwrite').put({fid,...obj});r.onsuccess=()=>res(true)})}
async function fileGet(fid){return new Promise((res)=>{const r=tx('files').get(fid);r.onsuccess=()=>res(r.result)})}
// REVIEWS
async function reviewAdd(rec){return new Promise((res)=>{const r=tx('reviews','readwrite').put(rec);r.onsuccess=()=>res(true)})}
async function reviewsByProduct(pid){return new Promise((res)=>{
  const out=[];const cursorReq=tx('reviews').openCursor();
  cursorReq.onsuccess=e=>{const c=e.target.result;if(c){if(c.value.pid===pid) out.push(c.value); c.continue()} else res(out)}
})}

/*************************
 * Auth (very light demo)
 *************************/
function currentUser(){try{return JSON.parse(localStorage.getItem('user'))}catch{return null}}
function requireUser(){const u=currentUser(); if(!u){alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç'); location.hash='#/profile';} return !!u}

/*************************
 * Catalog, Search, Cart
 *************************/
let CART = JSON.parse(localStorage.getItem('cart')||'[]');
function saveCart(){localStorage.setItem('cart',JSON.stringify(CART))}
function renderCatalog(){
  const q = ($('#search')?.value||'').toLowerCase();
  const listA=PRODUCTS.filter(p=>p.os==='android' && (!q || p.name.toLowerCase().includes(q)));
  const listI=PRODUCTS.filter(p=>p.os==='ios' && (!q || p.name.toLowerCase().includes(q)));
  $('#androidGrid').innerHTML=listA.map(cardHTML).join('');
  $('#iosGrid').innerHTML=listI.map(cardHTML).join('');
}
function cardHTML(p){
  return `<div class="card"><h3>${p.name}</h3><div class="price">${p.price}‚ÇΩ</div>
    <div class="row"><button class="btn" onclick="addToCart('${p.id}')">–í –∫–æ—Ä–∑–∏–Ω—É</button>
    <button class="btn ghost" onclick="location.hash='#/product:${p.id}'">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button></div></div>`
}
function addToCart(id){
  const p=PRODUCTS.find(x=>x.id===id);
  if(!CART.find(x=>x.id===id)){CART.push({id:p.id,name:p.name,price:p.price}); saveCart(); alert('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É');}
  else alert('–£–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ');
}
$('#search')?.addEventListener('input',renderCatalog);

function renderCart(){
  const root=$('#cartList');
  if(!CART.length){root.innerHTML='<div class="card">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';return}
  const sum = CART.reduce((a,b)=>a+b.price,0);
  root.innerHTML = CART.map(i=>`<div class="card row" style="justify-content:space-between"><div><b>${i.name}</b><div class='muted'>${i.price}‚ÇΩ</div></div><button class="btn warn" onclick="removeCart('${i.id}')">–£–¥–∞–ª–∏—Ç—å</button></div>`).join('')+
    `<div class="card row" style="justify-content:space-between"><div><b>–ò—Ç–æ–≥–æ:</b></div><div>${sum}‚ÇΩ</div></div>`;
}
function removeCart(id){CART=CART.filter(i=>i.id!==id); saveCart(); renderCart()}
$('#btnGoCheckout')?.addEventListener('click',()=>{ if(!CART.length) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); startCheckoutFromCart(); });

/*************************
 * Product view + Reviews
 *************************/
let CURRENT_PRODUCT=null;
async function openProduct(pid){
  CURRENT_PRODUCT = PRODUCTS.find(p=>p.id===pid);
  if(!CURRENT_PRODUCT){alert('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'); location.hash='#/catalog'; return}
  $('#productView').innerHTML = `<h2>${CURRENT_PRODUCT.name}</h2><div class='muted'>${CURRENT_PRODUCT.desc}</div>
    <div class='price'>–¶–µ–Ω–∞: <b>${CURRENT_PRODUCT.price}‚ÇΩ</b></div>
    <div class='row' style='margin-top:10px'><button class='btn' onclick="addToCart('${CURRENT_PRODUCT.id}')">–í –∫–æ—Ä–∑–∏–Ω—É</button>
    <button class='btn ghost' onclick="buyNow('${CURRENT_PRODUCT.id}')">–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button></div>`;
  location.hash = '#/product:'+pid; // ensure route
  renderReviewsUI(pid);
  show('#/product');
}
$('#btnAddReview')?.addEventListener('click', async ()=>{
  const text=$('#revText').value.trim(); const rate=parseInt($('#revRate').value||'5');
  if(!text) return alert('–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤');
  const rid=Math.random().toString(36).slice(2,10);
  await reviewAdd({rid, pid:CURRENT_PRODUCT.id, text, rate, author:(currentUser()?.username||'–ì–æ—Å—Ç—å'), ts:Date.now()});
  $('#revText').value=''; renderReviewsUI(CURRENT_PRODUCT.id); alert('–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω');
});
async function renderReviewsUI(pid){
  const list = await reviewsByProduct(pid);
  if(!list.length){$('#reviewsList').innerHTML='<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>'; return}
  const avg = (list.reduce((a,b)=>a+b.rate,0)/list.length).toFixed(1);
  $('#reviewsList').innerHTML = `<div class='row'><div class='pill'>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: ${avg} ‚òÖ</div><div class='pill'>–û—Ç–∑—ã–≤–æ–≤: ${list.length}</div></div>` +
    list.sort((a,b)=>b.ts-a.ts).map(r=>`<div class='card'><div class='row' style='justify-content:space-between'><b>${r.author}</b><span class='stars'>${'‚òÖ'.repeat(r.rate)}${'‚òÜ'.repeat(5-r.rate)}</span></div><div class='muted' style='margin-top:6px'>${r.text}</div></div>`).join('');
}
function buyNow(id){
  const p=PRODUCTS.find(x=>x.id===id); CART=[{id:p.id,name:p.name,price:p.price}]; saveCart(); startCheckoutFromCart();
}

/*************************
 * Checkout & Orders (IndexedDB persisted)
 *************************/
let ACTIVE_ORDER_ID=null;
function startCheckoutFromCart(){
  const sum=CART.reduce((a,b)=>a+b.price,0);
  $('#checkoutSummary').innerText = CART.map(i=>`${i.name} ‚Äî ${i.price}‚ÇΩ`).join(' \n ') + `\n–ò—Ç–æ–≥–æ: ${sum}‚ÇΩ`;
  location.hash='#/checkout'; show('#/checkout');
}
$('#btnPayDone')?.addEventListener('click', async ()=>{
  if(!CART.length) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
  const method= document.querySelector('input[name=paymethod]:checked').value;
  const note = $('#customerNote').value.trim();
  const id = Math.random().toString(36).slice(2,8);
  const order={id, items:[...CART], price:CART.reduce((a,b)=>a+b.price,0), method, note, status:'pending', files:[], createdAt:Date.now()};
  await ordersPut(order); CART=[]; saveCart(); ACTIVE_ORDER_ID=id; await renderWait(order.id);
  location.hash='#/wait';
});

async function renderWait(id){
  const o = await ordersGet(id||ACTIVE_ORDER_ID); if(!o) return;
  $('#waitInfo').innerText = `–ó–∞–∫–∞–∑ ${o.id}: ${o.items.map(i=>i.name).join(', ')} ‚Äî ${o.price}‚ÇΩ (–æ–ø–ª–∞—Ç–∞: ${o.method})`;
  $('#waitStatus').className = 'status ' + o.status; $('#waitStatus').innerText = o.status;
}

async function renderOrdersTable(){
  const list = (await ordersGetAll()).sort((a,b)=>b.createdAt-a.createdAt);
  const tbody = $('#ordersTable');
  if(!list.length){tbody.innerHTML = `<tr><td colspan='6'>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>`; return}
  tbody.innerHTML = list.map(o=>`<tr><td>${o.id}</td><td>${o.items.map(i=>i.name).join(', ')}</td><td>${o.price}‚ÇΩ</td><td>${o.method}</td><td><span class='status ${o.status}'>${o.status}</span></td><td>${o.status!=='delivered'?`<button class='btn ghost' onclick=\"goWait('${o.id}')\">–°—Ç–∞—Ç—É—Å</button>`:`<button class='btn ok' onclick=\"openDelivery('${o.id}')\">–ü–æ–ª—É—á–∏—Ç—å</button>`}</td></tr>`).join('');
}
window.goWait = async (id)=>{ACTIVE_ORDER_ID=id; await renderWait(id); location.hash='#/wait'}
window.openDelivery = async (id)=>{const o=await ordersGet(id); await showDelivery(o)}

async function showDelivery(order){
  if(!order) return; $('#deliverKey').innerText = 'KEY-' + order.id.toUpperCase();
  const box=$('#deliverFiles'); box.innerHTML='';
  if(order.files?.length){
    for(const fid of order.files){ const f = await fileGet(fid); if(!f) continue; const blob=new Blob([f.data],{type:f.type}); const a=document.createElement('a'); a.download=f.name; a.href=URL.createObjectURL(blob); a.className='btn ok'; a.textContent='üìÇ '+f.name; box.appendChild(a); }
  } else {
    const blob=new Blob([`–í–∞—à –∫–ª—é—á: KEY-${order.id.toUpperCase()}`],{type:'text/plain'});
    const a=document.createElement('a'); a.download='key.txt'; a.href=URL.createObjectURL(blob); a.className='btn ok'; a.textContent='–°–∫–∞—á–∞—Ç—å –∫–ª—é—á'; box.appendChild(a);
  }
  location.hash='#/delivered'; show('#/delivered');
}

/*************************
 * Profile (register/login demo)
 *************************/
function renderProfile(){
  const u=currentUser();
  if(u){
    $('#profileBox').innerHTML = `<div class='row' style='justify-content:space-between'><div><b>${u.username}</b><div class='muted'>${u.email}</div></div><button class='btn warn' onclick='logout()'>–í—ã–π—Ç–∏</button></div>
    <div class='row' style='margin-top:10px'><button class='btn' data-link='#/orders' onclick='location.hash="#/orders"'>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</button></div>`;
  } else {
    $('#profileBox').innerHTML = `<div class='row' style='gap:6px;flex-direction:column;align-items:stretch'>
      <input id='regName' class='input' placeholder='–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'>
      <input id='regEmail' class='input' placeholder='Email'>
      <input id='regPass' type='password' class='input' placeholder='–ü–∞—Ä–æ–ª—å'>
      <button class='btn' onclick='register()'>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      <div class='muted'>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–≤–µ–¥–∏—Ç–µ Email –∏ –ü–∞—Ä–æ–ª—å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í–æ–π—Ç–∏¬ª.</div>
      <button class='btn ghost' onclick='login()'>–í–æ–π—Ç–∏</button>
    </div>`;
  }
}
function register(){
  const username=$('#regName').value.trim(); const email=$('#regEmail').value.trim(); const password=$('#regPass').value;
  if(!username||!email||!password) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
  localStorage.setItem('user',JSON.stringify({username,email,password})); alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'); renderProfile();
}
function login(){
  const email=$('#regEmail').value.trim(); const pass=$('#regPass').value; const u=currentUser();
  if(u && u.email===email && u.password===pass){ alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); renderProfile()} else alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
}
function logout(){ localStorage.removeItem('user'); renderProfile(); }

/*************************
 * Admin (login + manage orders + attach files)
 *************************/
const ADMIN={logged:false,user:'HuperKillon',pass:'Lop123lop'};
function renderAdmin(){
  $('#adminAuth').innerHTML = ADMIN.logged ? `<span class='pill'>–í—Ö–æ–¥: admin</span> <button class='btn warn' onclick='adminLogout()'>–í—ã–π—Ç–∏</button>` : `
    <input id='admUser' class='input' placeholder='–õ–æ–≥–∏–Ω' style='max-width:140px'>
    <input id='admPass' type='password' class='input' placeholder='–ü–∞—Ä–æ–ª—å' style='max-width:160px'>
    <button class='btn' onclick='adminLogin()'>–í–æ–π—Ç–∏</button>`;
  $('#adminArea').classList.toggle('hidden',!ADMIN.logged);
  if(ADMIN.logged) fillAdminOrders();
}
function adminLogin(){ ADMIN.logged = ($('#admUser').value===ADMIN.user && $('#admPass').value===ADMIN.pass); if(!ADMIN.logged) alert('–ù–µ–≤–µ—Ä–Ω–æ'); renderAdmin(); }
function adminLogout(){ ADMIN.logged=false; renderAdmin(); }
async function fillAdminOrders(){
  const list= (await ordersGetAll()).sort((a,b)=>b.createdAt-a.createdAt);
  $('#adminOrders').innerHTML = list.map(o=>`<tr><td>${o.id}</td><td>${o.items.map(i=>i.name).join(', ')}</td><td>${o.price}‚ÇΩ</td><td>${o.method}</td><td>${o.note||''}</td><td><span class='status ${o.status}'>${o.status}</span></td><td>
    ${o.status==='pending'?`<button class='btn ghost' onclick=\"admConfirm('${o.id}')\">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>`:''}
    <button class='btn ok' onclick=\"admDeliver('${o.id}')\">–í—ã–¥–∞—Ç—å</button></td></tr>`).join('');
}
async function admConfirm(id){ const o=await ordersGet(id); if(!o) return; o.status='confirmed'; await ordersPut(o); await fillAdminOrders(); if(ACTIVE_ORDER_ID===id) await renderWait(id) }
async function admDeliver(id){ const o=await ordersGet(id); if(!o) return; o.status='delivered'; await ordersPut(o); await fillAdminOrders(); if(ACTIVE_ORDER_ID===id) await showDelivery(o) }

// Attach files to order (persisted in IndexedDB as ArrayBuffer)
$('#btnAttachFiles')?.addEventListener('click', async ()=>{
  const id = $('#fileOrderId').value.trim(); if(!id) return alert('–£–∫–∞–∂–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞');
  const o = await ordersGet(id); if(!o) return alert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
  const files = $('#fileInput').files; if(!files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã');
  if(!o.files) o.files=[];
  const limit=20; if(o.files.length + files.length > limit) return alert('–õ–∏–º–∏—Ç 20 —Ñ–∞–π–ª–æ–≤ –Ω–∞ –∑–∞–∫–∞–∑');
  for(const f of files){
    const buf = await f.arrayBuffer(); const fid = id+'_'+Math.random().toString(36).slice(2,8);
    await filePut(fid,{name:f.name,type:f.type,data:buf,orderId:id,ts:Date.now()});
    o.files.push(fid);
  }
  await ordersPut(o); $('#fileInput').value=''; alert('–§–∞–π–ª—ã –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã'); await fillAdminOrders();
});

/*************************
 * Boot
 *************************/
(async function(){
  await dbOpen();
  // open route
  const h = location.hash.split('?')[0];
  if(h.startsWith('#/product:')){ openProduct(h.split(':')[1]); }
  else show(h);
})();
</script>
</body>
</html>
